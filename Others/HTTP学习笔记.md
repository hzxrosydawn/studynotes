---

---

# HTTP学习笔记

### HTTP协议简介

HTTP协议（HyperText Transfer Protocol，超文本传输协议）是因特网上应用最为广泛的一种网络传输协议，所有的WWW文件都必须遵守这个标准。HTTP基于TCP/IP通信协议来传递数据（HTML 文件, 图片文件, 查询结果等）。它是一种可靠的数据传输协议，能够确保数据在传输的过程中不会被损坏或产生混乱。

### Web资源

#### MIME 类型

MIME类型（Multipurpose Internet Mail Extension，多用途因特网邮件扩展）是一种文本标记，用于标识Web上传输的各种对象。表示一种主要的对象类型和一个特定的子类型，中间由一条斜杠来分隔。如：

-  text/html：表示HTML文本文档；
-  text/plain：表示普通ASCII文本文档；
-  application/vnd.ms-powerpoint：表示微软的PowerPoint演示文件。

更多的MIIME类型参考[MIME百科](http://baike.baidu.com/link?url=DkM3ZI9jku3BGHYmF9fvaErwIfgHFb4H_23LHtuIBUcu7HHCijlxHsx-XDh1FSskqLPEXIjQ77fgfYqexKRyV_)或[w3schoo的MIME参考手册](http://www.w3school.com.cn/media/media_mimeref.asp)。

#### URI、URL和URN

URI（Uniform Resource Identiﬁer，统一资源标识符）用于在世界范围内唯一标识并定位Web服务器资源，有URL和URN两种形式。

URL（Uniform Resource Locator，统一资源定位符）描述了一台特定服务器上某资源的特定位置，从而定位因特网上任意资源。也就是我们平时说的网址，现在几乎所有的URI都是URL，除非特殊说明，一般URI都是指URL。

大部分URL都会遵循通用的URL语法：

```http
<scheme>://<user>:<password>@<host>:<post>/<path>;<params>?<query>#<frag>
```

不同 URL 方案的风格和语法都有不少重叠。几乎没有哪个URL中包含了所有这些组件。URL 最重要的3个部分是方案（scheme）、主机（host）和路径（path）。通用URL组件如下表所示：

| 组件           | 描述                                       |      默认值      |
| ------------ | ---------------------------------------- | :-----------: |
| 方案（scheme）   | 访问服务器以获取资源时要使用哪种协议                       |       无       |
| 用户（user）     | 某些方案访问资源时需要的用户名                          |      匿名       |
| 密码（password） | 用户名后面可能要包含的密码，中间由冒号（:）分隔                 | \<E-mail 地址 > |
| 主机（host）     | 资源宿主服务器的主机名或点分IP地址                       |       无       |
| 端口（port）     | 资源宿主服务器正在监听的端口号。很多方案都有默认端口号（HTTP 的默认端口号为 80） |    每个方案特有     |
| 路径（path）     | 服务器上资源的本地名，由一个斜杠（/）将其与前面的URL 组件分隔开来。路径组件的语法是与服务器和方案有关的 |       无       |
| 参数（params）   | 某些方案会用这个组件来指定输入参数。参数为名 / 值对。URL 中可以包含多个参数字段，它们相互之间以及与路径的其余部分之间用分号（;）分隔 |       无       |
| 查询（query）    | 某些方案会用这个组件传递参数以激活应用程序（比如数据库、公告板、搜索引擎以及其他因特网网关）。查询组件的内容没有通用格式。用字符“?”将其与URL的其余部分分隔开来，多个查询条件之间以“&”分隔 |       无       |
| 片段（frag）     | 一小片或一部分资源的名字。引用对象时，不会将frag字段传送给服务器；这个字段是在客户端内部使用的。通过字符“#”将其与URL的其余部分分隔开来 |       无       |

**方案** ：方案组件指定了访问服务器以获取资源时要使用的哪种协议。方案名必须以一个字母符号开始，由第一个“:”符号将其与 URL 的其余部分分隔开来。方案名是大小写无关的。这部分通常是HTTP协议（http://），也可以是其他协议形式。完整的方案列表如下：

- **http** ：超文本传输协议方案，除了没有用户名和密码之外，与通用的 URL 格式相符。如果省略了端口，就默认为 80。基本格式：http://\<host>:\<port>/\<path>?\<query>#\<frag>。
- **https** ：方案 https 与方案 http 是一对。唯一的区别在于方案 https 使用了网景的 SSL，SSL 为HTTP 连接提供了端到端的加密机制。其语法与 HTTP 的语法相同，默认端口为 443。基本格式：https://\<host>:\<port>/\<path>?\<query>#\<frag>。
- **mailto** ： Mailto URL 指向的是 E-mail 地址。由于 E-mail 的行为与其他方案都有所不同（它并不指向任何可以直接访问的对象），所以 mailto URL 的格式与标准 URL 的格式也有所不同。因特网 E-mail 地址的语法记录在 RFC 822 中。基本格式：mailto:\<RFC-822-addr-spec>，如mailto:joe@joes-hardware.com。
- **ftp** ：**文件传输协议** URL 可以用来从 FTP 服务器上下载或向其上载文件，并获取 FTP 服务器上的目录结构内容的列表。
  在 Web 和 URL 出现之前 FTP 就已经存在了。Web 应用程序将 FTP 作为一种数据访问方案使用。URL 语法遵循下列通用格式。基本格式：ftp://\<user>:\<password>@\<host>:\<port>/\<path>;\<params>，示例：ftp://anonymous:joe%40joes-hardware.com@prep.ai.mit.edu:21/pub/gnu/。
- **rtsp，rtspu** ：RTSP URL 是可以通过**实时流传输协议**（Real Time Streaming Protocol）解析的音 / 视频媒体资源的标识符。方案 rtspu 中的 u 表示它是使用 UDP 协议来获取资源的。基本格式：rtsp://\<user>:\<password>@\<host>:\<port>/\<path>，rtspu://\<user>:\<password>@\<host>:\<port>/\<path>，示例：rtsp://www.joes-hardware.com:554/interview/cto_video。
- **file** ：方案 file 表示一台指定主机（通过本地磁盘、网络文件系统或其他一些文件共享系统）上可直接访问的文件。各字段都遵循通用格式。如果省略了主机名，就默认为正在使用URL 的本地主机。基本格式：file://\<host>/\<path>
  示例：file://OFFICE-FS/policies/casual-fridays.doc。
- **news**  ：根据 RFC 1036 的定义，方案 news 用来访问一些特定的文章或新闻组。它有一个很独特的性质：news URL 自身包含的信息不足以对资源进行定位。news URL 中缺乏到何处获取资源的信息——没有提供主机名或机器名称。从用户那里获取此类信息是解释程序的工作。比如，在网景浏览器的“选项”（Options）菜单中，就可以指定自己的 NNTP（news）服务器。这样，浏览器有了 news URL 的时候就知道应该使用哪个服务器了。新闻资源可以从多台服务器中获得。它们被称为位置无关的，因为对它们的访问不依赖于任何一个源服务器。news URL 中保留了字符“@”，用来区分指向新闻组的 news URL 和指向特定新闻文章的news URL。基本格式：news:\<newsgroup>，news:\<news-article-id>，示例：news:rec.arts.startrek。
- **telnet** ： 方案 telnet 用于访问交互式业务。它表示的并不是对象自身，而是可通过 telnet 协议访问的交互式应用程序（资源）。基本格式：telnet://\<user>:\<password>@\<host>:\<port>/示例：telnet://slurp:webhound@joes-hardware.com:23/。

**主机与端口** ：主机组件可以是服务器主机的IP地址或文本域名（也称为主机名，比如 www.baidu.com，比IP地址人性化）。文本域名可以通过域名服务（Domain Name Service，DNS）的机制转换成IP地址。端口组件标识了服务器正在监听的网络端口。对于HTTP来说，默认端口号为80。

**用户名和密码** ：很多服务器（如FTP 服务器）都要求输入用户名和密码才会允许用户访问数据。如：

ftp://anonymous:my_passwd@ftp.prep.ai.mit.edu/pub/gnu。

**路径** ：路径组件说明了资源位于服务器的什么地方。路径通常很像一个分级的文件系统路径。**每个路径段都有自己的参数（param）组件**。

**参数** ：在某些方案中，参数组件可为应用程序提供访问资源所需的所有附加信息，以便正确地与服务器进行交互。参数为名 / 值对的形式。URL 中可以包含多个参数字段，它们相互之间以及与路径的其余部分之间用分号（;）分隔。如HTTP URL的路径组件可以分成若干路径段。每段都可以有自己的参数。比如：

http://www.joes-hardware.com/hammers;sale=false/index.html;graphics=true

**查询** ：查询（query）组件通过提问题或进行查询方式来缩小某些请求资源（比如数据库服务）类型范围。用字符“?”将查询组件与其前面的URL部分分隔开来，多个查询条件之间以“&”分隔。如：

http://www.joes-hardware.com/inventory-check.cgi?item=12731&color=blue&size=large

**片段** ：为了引用部分资源或资源的一个片段，URL支持使用片段（frag）组件来表示一个资源内部的片段。比如，指向
一个带有章节的文档中的某个章节处。片段位于URL的最右边，最前面有一个字符“#”。比如：

http://www.joes-hardware.com/tools.html#drills

访问上面的链接后，服务器返回整个HTML页面，然后向下滚动，从名为drills的片段处开始显示。

**相对URL** ：相比包含了访问资源所需的全部信息的绝对URL ，相对URL表示相对于基础URL（base URL）的一个不完整的URL。相对URL使用缩略形式的语法，省去了方案、主机和其他一些组件了。比如\<a href="./hammers.html">。

相对 URL 为保持一组资源（比如一些 HTML 页面）的可移植性提供了一种便捷方式。如果使用的是相对 URL，就可以在搬移一组文档的同时，仍然保持链接的有效性，因为相对 URL 都是相对于新基础进行解释的。这样就可以实现在其他服务器上提供镜像内容之类的功能了。

将相对 URL 转换成绝对 URL的流程如下：

![相对URL](appendix/相对URL.png)

**自动扩展UR**L：有些浏览器会在用户提交URL之后，或者在用户输入的时候尝试着自动扩展URL。大大方便用户了用户的输入。一般情况下，浏览器可以通过主机名和浏览历史进行URL的自动扩展。

**URL编码**：URL是可移植的（可通过**各种不同的协议**来传送资源），同时URL传输是安全的（不会丢失信息），所以URL只能使用相对较小的、通用的ASCII 字符集。但是ASCII字符集不能用来表示其他语言的字符，故URL使用一种[“转义”编码机制](http://baike.baidu.com/link?url=bOlexnfD9D_zicGNcAbTC3J-XaU3WoAqa-iFmNG3OKf29m9t0moqgo2Hps0vaUVrvkRJGzrRfjFb17J7Z1DAPAiUnk3-ZN7T5B5Ck7hsKVa)，即使用一个带有“%”的两位十六进制数字来表示非ASCII字符。比如“\”，它的ASCII码是92，92的十六进制是5C，所以“\”的URL编码就是%5C。汉字的URL编码信息多了一些，比如“胡”的ASCII码是-17670，十六进制是BAFA，RUL编码就是“%BA%FA”。

比如在搜索引擎中输入一段汉字，就会在浏览器地址栏里看到中文部分被转义了（转义后的字符的MIME类型为application/x-www-form-urlencode）。在Web开发中提交表单的时候，form表单参数中会有一个enctype的参数。enctype指定了HTTP请求的Content-Type。默认情况下，HTML的form表单的enctype=application/x-www-form-urlencoded。application/x-www-form-urlencoded是指表单的提交，并且将提交的数据进行urlencode。默认情况下，我们所有的表单提交都是通过这种默认的方式实现的。

在URL中，有几个字符被保留起来，有着特殊的含义。有些字符不在定义的ASCII可打印字符集中。还有些字符会与某些因特网网关和协议产生混淆，因此不赞成使用。

**URN** ：即统一资源名（Uniform Resource Name ）作为特定内容的唯一名称使用的，与目前的资源所在地无关。仍处于试验阶段。

### 报文

HTTP 报文是在 HTTP 应用程序之间发送的数据块。这些数据块以一些文本形式的元信息（meta-information）开头，这些信息描述了报文的内容及含义，后面跟着可选的数据部分。这些报文在客户端、服务器和代理之间流动。

HTTP报文由简单的文本字符串组成，分为以下两种形式：

- 请求报文（request message）：从客户端发往服务器的HTTP报文；
- 响应报文（response message）：从服务器发往客户端的报文。

请求报文的格式：

```html
<method> <request-URL> <version>
<headers>

<entity-body>
```

响应报文的格式（注意，只有起始行的语法有所不同）：

```html
<version> <status> <reason-phrase>
<headers>

<entity-body>
```

HTTP报文包括以下三个部分：

- **起始行（start line）**：即报文的第一行。请求报文的起始行又叫**请求行**，包含了一个**方法** 参考后面的方法介绍）和一个**请求URL**，这个方法描述了服务器应该执行的操作，请求URL描述了要对哪个资源执行这个方法。请求行中还包含**HTTP版本**，用来告知服务器，客户端使用的是哪种HTTP。响应报文的起始行又叫**响应行**，包含了响应报文使用的**HTTP版本**、**数字状态码**，以及描述操作状态的文本形式的**原因短语**。所有这些字段都**由空格符分隔**；
- **首部（header）块**：起始行后面有零个或多个首部字段。每个首部字段都包含一个名字和一个值，为了便于解析，两者之间用冒号（:）来分隔。首部字段以一个空行结束；


- **主体（body）**：空行之后就是可选的报文主体了，其中可包含所有类型的数据。请求主体中包括了要发送给Web服务器的数据；响应主体中装载了要返回给客户端的数据。起始行和首部都是文本形式且都是结构化的，而主体则不同，主体中可以包含任意的二进制数据（比如图片、视频、音轨、软件程序）。当然，主体中也可以包含文本。

HTTP 规范中说明应该用CRLF （回车换行符，carriage return/line feed）来表示起始行和首部的行终止、以及作为首部块与主体分隔符，但稳健的应用程序也应该接受单个换行符作为行的终止。有些老的，或不完整的 HTTP 应用程序并不总是既发送回车符，又发送换行符。

![http4](appendix/http4.png)

下面对各部分进行简要描述：

- **方法（method）** ：客户端希望服务器对资源执行的动作。是一个单独的词，比如 GET、HEAD 或 POST；
- **请求URL（request-URL）** ：命名了所请求资源，或者 URL 路径组件的完整 URL；
- **版本（version）** ：报文所使用的HTT 版本，其格式为：HTTP/\<major>.\<minor>，其中主要版本号（major）和次要版本号（minor）都是单独的整数。因此在比较HTTP版本时，每个数字都必须单独进行比较，以便确定哪个版本更高。比如，HTTP/2.22 就比HTTP/2.3 的版本要高，因为22比3大；
- **状态码（status-code）** ：这三位数字描述了请求过程中所发生的情况。每个状态码的第一位数字都用于描
  述状态的一般类别（“成功”、“出错”等）；
- **原因短语（reason-phrase）** ：数字状态码的简要描述；
- **首部（header）字段** ：可以有零个或多个首部，每个首部都包含一个名字，后面跟着一个冒号（:），然后是一个可选的空格，接着是一个值，最后是一个CRLF。**首部是由一个空行（CRLF）结束的**，表示了首部列表的结束和实体主体部分的开始。有些HTTP版本，比如HTTP/1.1，要求有效的请求或响应报文中必须包含特定的首部；
- **实体的主体部分（entity-body）** ：实体的主体部分包含一个由任意数据组成的数据块。并不是所有的报文都包含实
  体的主体部分，有时，报文只是以一个CRLF结束。




### 事务

一个 HTTP 事务由一条（从客户端发往服务器的）请求命令和一个（从服务器发回客户端的）响应结果组成。这种通信是通过名为 HTTP 报文（HTTP message）的格式化数据块进行的。如下图所示：

![http2](appendix/http2.png)

#### 方法

HTTP支持的**请求命令被称为HTTP方法**（HTTP method）。每条HTTP请求报文都包含一个方法，这个方法会告诉服务器要执行什么动作。常见的HTTP方法如下：

- GET：从服务器向客户端发送命名资源；
- PUT：将来自客户端的数据存储到一个命名的服务器资源中去；
- DELETE 从服务器中删除命名资源；
- POST 将客户端数据发送到一个服务器网关应用程序；
- HEAD 仅发送命名资源响应中的 HTTP 首部。

#### 状态码

每条HTTP响应报文返回时都会携带一个状态码。状态码是一个三位数字的代码，告知客户端请求是否成功，或者是否需要采取其他动作。常见状态码如下：

- 200：OK。文档正确返回；
- 302：Redirect（重定向）。到其他地方去获取资源；
- 404：Not Found（没找到）。无法找到这个资源。

伴随着每个数字状态码，HTTP 还会发送一条解释性的“原因短语”文本。如：

```http
200 OK
200 Success
```

这些文本短语主要是为了进行描述，所有的处理过程使用的都是数字码。

> 注意：应用程序完成一项任务时通常会发布多个HTTP事务。如一个Web页面中的许多图片可能来自不同的服务器上。


### 连接

HTTP是个应用层协议。它不用去关系网络通信的具体细节，而是把联网的细节都交给了通用、可靠的因特网传输协议 TCP/IP协议。TCP提供了：

- 无差错的数据传输。保证了数据传输的完整性；
- 按序传输。数据总是会按照发送的顺序到达；
- 未分段的数据流。可以在任意时刻以任意尺寸将数据发送出去；
- 无视网络设备差异。任何计算机和网络都能够进行可靠地通信。

在HTTP客户端向服务器发送报文之前，需要用IP（Internet Protocol，网际协议）地址和端口号在客户端和服务器之间建立一条 TCP/IP 连接。基本的浏览器连接处理如下图所示：

![http3](appendix/http3.png)

步骤如下：

1.  浏览器从 URL 中解析出服务器的主机名；
2.  浏览器将服务器的主机名转换成服务器的 IP 地址；
3.  浏览器将端口号（如果有的话）从 URL 中解析出来；
4.  浏览器建立一条与 Web 服务器的 TCP 连接；
5.  浏览器向服务器发送一条 HTTP 请求报文；
6.  服务器向浏览器回送一条 HTTP 响应报文；
7.  关闭连接，浏览器显示文档。

### Web的结构组件

除Web浏览器和Web服务器两个应用程序，在因特网上，要与很多Web应用程序进行交互，再来列出一些重要的应用程序。
**代理**
位于客户端和服务器之间的HTTP中间实体；
作用：接受所有客户端的HTTP请求，并将这些请求转发给服务器。
**缓存**
HTTP的仓库，使常用页面的副本可以保存在离科幻段更近的地方。

作用：可以将经过代理传送的常用文档复制保存起来。下一个请求同一文档的客户端就可以享受缓存的私有副本所提供的服务了。
**网关**
链接其他应用程序的特殊Web服务器
作用：通常将HTTP流量转换成其他的协议
隧道
对HTTP通信报文记性盲转换的特殊代理
作用：通过HTTP链接承载加密的安全套接字层（SLL，Security Socket Layer）流量，这样SSL就可以穿过只允许Web流量通过的防火墙了。
**Agency代理**
发起自动HTTP请求的半智能Web客户端
作用：有些自己会在Web上闲逛的自动用户Agent代理，可以在无人监视的情况下发布HTTP事务并获取内容。Eg：网络蜘蛛（spider），Web机器人（Web robots）。

现在使用的HTTP协议有几个版本：HTTP/0.9、HTTP/1.0、 HTTP/1.0+、HTTP/1.1（现今使用的）和HTTP-NG（HTTP/2.0）。







### HTTP 工作原理

HTTP协议工作于客户端-服务端架构为上。浏览器作为HTTP客户端通过URL向HTTP服务端即WEB服务器发送所有请求。Web服务器（Apache服务器，IIS服务器（Internet Information Services）等）接收到的请求后，向客户端发送响应信息。

HTTP默认端口号为80，但是你也可以改为8080或者其他端口。

HTTP三点注意事项：

- HTTP是无连接：无连接的含义是限制每次连接只处理一个请求。服务器处理完客户的请求，并收到客户的应答后，即断开连接。采用这种方式可以节省传输时间；
- HTTP是媒体独立的：这意味着，只要客户端和服务器知道如何处理的数据内容，任何类型的数据都可以通过HTTP发送。客户端以及服务器指定使用适合的MIME-type内容类型；
- HTTP是无状态：HTTP协议是无状态协议。无状态是指协议对于事务处理没有记忆能力。缺少状态意味着如果后续处理需要前面的信息，则它必须重传，这样可能导致每次连接传送的数据量增大。另一方面，在服务器不需要先前信息时它的应答就较快。

以下图表展示了HTTP协议通信流程：